# Dockerfile.from-binaries-optimized
# Optimized build - only copies essential DCGM files (~100MB instead of 4.7GB)

FROM ubuntu:22.04

# Install system and Python dependencies
RUN apt-get update && \
	apt-get install -y python3 python3-pip curl && \
	apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Python dependencies for OpenTelemetry
RUN pip3 install --no-cache-dir \
	opentelemetry-sdk \
	opentelemetry-api \
	opentelemetry-exporter-otlp \
	opentelemetry-sdk-extension-aws \
	psutil \
	requests

# Create directory structure
RUN mkdir -p /root/Workspace/DCGM/_out/Linux-amd64-debug/bin \
    /root/Workspace/DCGM/_out/Linux-amd64-debug/lib \
    /root/Workspace/DCGM/_out/Linux-amd64-debug/share/dcgm_tests/apps/amd64 \
    /usr/local/dcgm/bin \
    /usr/local/dcgm/share/dcgm_tests/apps/amd64

# Copy ONLY essential DCGM binaries (optimized - no CUBLAS, no test tools)
COPY dcgm_optimized/bin/nv-hostengine /root/Workspace/DCGM/_out/Linux-amd64-debug/bin/nv-hostengine
COPY dcgm_optimized/share/dcgm_tests/apps/amd64/dcgmi /root/Workspace/DCGM/_out/Linux-amd64-debug/share/dcgm_tests/apps/amd64/dcgmi
COPY dcgm_optimized/lib/ /root/Workspace/DCGM/_out/Linux-amd64-debug/lib/
COPY dcgm_optimized/share/dcgm_tests/ /root/Workspace/DCGM/_out/Linux-amd64-debug/share/dcgm_tests/

# Create symlinks for both nv-hostengine and dcgmi (entrypoint expects them here)
RUN ln -s /root/Workspace/DCGM/_out/Linux-amd64-debug/bin/nv-hostengine /usr/local/dcgm/bin/nv-hostengine && \
    ln -s /root/Workspace/DCGM/_out/Linux-amd64-debug/share/dcgm_tests/apps/amd64/dcgmi /usr/local/dcgm/share/dcgm_tests/apps/amd64/dcgmi

# Copy Python scripts from src/
COPY src/dcgm_exporter.py /root/Workspace/DCGM/_out/Linux-amd64-debug/dcgm_exporter.py
COPY src/dcgm_uds_server.py /root/Workspace/DCGM/_out/Linux-amd64-debug/dcgm_uds_server.py
COPY src/docker-entrypoint.sh /usr/local/bin/docker-entrypoint.sh
COPY src/dcgm_fake_manager.py /root/Workspace/DCGM/_out/Linux-amd64-debug/dcgm_fake_manager.py

# Make scripts executable
RUN chmod +x \
    /root/Workspace/DCGM/_out/Linux-amd64-debug/dcgm_exporter.py \
    /root/Workspace/DCGM/_out/Linux-amd64-debug/dcgm_uds_server.py \
    /root/Workspace/DCGM/_out/Linux-amd64-debug/dcgm_fake_manager.py \
    /usr/local/bin/docker-entrypoint.sh

# Set environment variables
ENV LD_LIBRARY_PATH=/root/Workspace/DCGM/_out/Linux-amd64-debug/lib
ENV LD_PRELOAD=/root/Workspace/DCGM/_out/Linux-amd64-debug/lib/libnvml_injection.so.1
ENV NVML_INJECTION_MODE=1
ENV PYTHONPATH=/root/Workspace/DCGM/_out/Linux-amd64-debug/share/dcgm_tests
ENV EXPORTER_PORT=9400
ENV NUM_FAKE_GPUS=4
ENV METRIC_PROFILE=static
ENV METRIC_UPDATE_INTERVAL=30
ENV GPU_START_INDEX=1
ENV DCGM_DIR=/root/Workspace/DCGM/_out/Linux-amd64-debug
ENV PATH="$PATH:/root/Workspace/DCGM/_out/Linux-amd64-debug/bin"
ENV ENABLE_UDS=false
ENV UDS_SOCKET_PATH=/var/run/dcgm/metrics.sock

EXPOSE 5555 9400

HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:${EXPORTER_PORT}/health || exit 1

ENTRYPOINT ["/usr/local/bin/docker-entrypoint.sh"]
